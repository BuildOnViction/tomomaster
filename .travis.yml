sudo: required
language: node_js
node_js: "8"

jobs:
  include:
    - stage: Lint
      script: npm run lint
    - stage: Test
    - stage: Coverage
      script: npm run coverage && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage
    - stage: Build and push Docker images
      install: skip
      script: skip
      services:
        - docker
      before_install:
        - docker build -t tomochain/tomomaster .
      deploy:
        provider: script
        script:
          - bash docker_push.sh latest
          - bash docker_push.sh $TRAVIS_BUILD_ID
        on:
          branch: master
          tags: false
      deploy:
        provider: script
        script:
          - bash docker_push.sh latest
          - bash docker_push.sh $TRAVIS_TAG
        on:
          branch: master
          tags: true
    - stage: Trigger rebuild of infrastructure images
      sudo: false
      install: skip
      script: bash docker_rebuild.sh

stages:
  - name: Lint
  - name: Test
  - name: Coverage
  - name: Build and push Docker images
    if: type != pull_request AND branch = master AND repo = tomochain/tomomaster
  - name: Trigger rebuild of infrastructure images
    if: type != pull_request AND branch = master AND repo = tomochain/tomomaster

sudo: required
language: node_js
node_js: "8"

jobs:
  include:
    - stage: Lint
      script: npm run lint
    - stage: Test
    - stage: Build and push Docker images
      install: skip
      script: skip
      services:
        - docker
      before_install:
        - docker build -t tomochain/tomomaster .
      deploy:
        provider: script
        script: bash docker_push.sh
        on:
          branch: master
    - stage: Trigger rebuild of infrastructure images
      sudo: false
      install: skip
      script: bash docker_rebuild.sh

stages:
  - name: Build and push Docker images
    if: type != pull_request AND branch = master
  - name: Trigger rebuild of infrastructure images
    if: type != pull_request AND branch = master
